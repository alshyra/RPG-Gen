name: Build, Push, and Deploy

on:
  push:
    branches:
      - main
    tags:
      - "*"
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: europe-west1
  SERVICE_NAME: rpggen

permissions:
  contents: read
  id-token: write

jobs:
  determine-version:
    name: Determine Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.VERSION }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # On tag: extract tag name (remove refs/tags/ prefix)
            VERSION=${GITHUB_REF#refs/tags/}
          else
            # On push to main: use short SHA
            VERSION=$(git rev-parse --short HEAD)
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Determined version: $VERSION"
          echo "Ref: ${{ github.ref }}"

  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: determine-version
    if: github.event_name != 'pull_request'
    strategy:
      matrix:
        include:
          - dockerfile: Dockerfile.backend
            image: antoinesavajols/rpggen-back
          - dockerfile: Dockerfile.frontend
            image: antoinesavajols/rpggen-front

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ matrix.image }}
          tags: |
            type=ref,event=tag
            type=sha,format=short,prefix=

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./${{ matrix.dockerfile }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ matrix.image }}:buildcache
          cache-to: type=registry,ref=${{ matrix.image }}:buildcache,mode=max

  test-build-on-pr:
    name: Test Docker Build (PR only)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    strategy:
      matrix:
        dockerfile: [Dockerfile.backend, Dockerfile.frontend]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Test build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./${{ matrix.dockerfile }}
          push: false
          tags: test:${{ matrix.dockerfile }}

  deploy-cloud-run:
    name: Deploy to Cloud Run
    runs-on: ubuntu-latest
    needs: [determine-version, build-and-push]
    if: github.event_name != 'pull_request'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Update Cloud Run service with image version
        env:
          VERSION: ${{ needs.determine-version.outputs.version }}
        run: |
          export VERSION
          envsubst < k8s/cloud-run-service.yaml > k8s/cloud-run-service-resolved.yaml
          mv k8s/cloud-run-service-resolved.yaml k8s/cloud-run-service.yaml

      - name: Create/Update GCP Secrets
        run: |
          # MongoDB URI
          echo -n "${{ secrets.MONGODB_URI }}" | gcloud secrets create mongodb-uri --data-file=- --replication-policy="automatic" 2>/dev/null || \
          echo -n "${{ secrets.MONGODB_URI }}" | gcloud secrets versions add mongodb-uri --data-file=-

          # Google API Key
          echo -n "${{ secrets.GOOGLE_API_KEY }}" | gcloud secrets create google-api-key --data-file=- --replication-policy="automatic" 2>/dev/null || \
          echo -n "${{ secrets.GOOGLE_API_KEY }}" | gcloud secrets versions add google-api-key --data-file=-

          # Google OAuth Client ID
          echo -n "${{ secrets.GOOGLE_OAUTH_CLIENT_ID }}" | gcloud secrets create google-oauth-client-id --data-file=- --replication-policy="automatic" 2>/dev/null || \
          echo -n "${{ secrets.GOOGLE_OAUTH_CLIENT_ID }}" | gcloud secrets versions add google-oauth-client-id --data-file=-

          # Google OAuth Client Secret
          echo -n "${{ secrets.GOOGLE_OAUTH_CLIENT_SECRET }}" | gcloud secrets create google-oauth-client-secret --data-file=- --replication-policy="automatic" 2>/dev/null || \
          echo -n "${{ secrets.GOOGLE_OAUTH_CLIENT_SECRET }}" | gcloud secrets versions add google-oauth-client-secret --data-file=-

          # JWT Secret
          echo -n "${{ secrets.JWT_SECRET }}" | gcloud secrets create jwt-secret --data-file=- --replication-policy="automatic" 2>/dev/null || \
          echo -n "${{ secrets.JWT_SECRET }}" | gcloud secrets versions add jwt-secret --data-file=-

      - name: Create/Update Cloud Run Service
        run: |
          gcloud run services replace k8s/cloud-run-service.yaml \
            --region=${{ env.REGION }} \
            --project=${{ env.PROJECT_ID }}

      - name: Get Service URL
        id: service-url
        run: |
          URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --project=${{ env.PROJECT_ID }} \
            --format='value(status.url)')
          echo "url=$URL" >> $GITHUB_OUTPUT

      - name: Print Deployment Info
        run: |
          echo "âœ… Deployed to Cloud Run"
          echo "Service URL: ${{ steps.service-url.outputs.url }}"
          echo "Region: ${{ env.REGION }}"
          echo "Project: ${{ env.PROJECT_ID }}"
          echo "Image version: ${{ needs.determine-version.outputs.version }}"
