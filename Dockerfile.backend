FROM node:25.2.0-alpine3.22 AS base_node
FROM base_node AS builder

# Copy the root package files and workspace packages to support npm workspaces
WORKDIR /app
COPY package*.json ./
COPY packages ./packages

# Install at root (workspace install) for proper workspace dependency resolution
RUN npm ci

# Build the backend workspace
WORKDIR /app/packages/backend
RUN npm --workspace rpg-gemini-backend run build && npm prune --production

FROM base_node

WORKDIR /app/packages/backend

COPY --from=builder /app/ /app

EXPOSE 3001

CMD ["npm", "run", "start"]
